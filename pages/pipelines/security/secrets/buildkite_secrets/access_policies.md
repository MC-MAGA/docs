# Access policies for Buildkite organization secrets

Access policies for Buildkite organization secrets:

- Control access to [Buildkite secrets](/docs/pipelines/security/secrets/buildkite-secrets) based on build attributes. Policies are written in YAML and configured through the Buildkite interface.

- Restrict access to cluster secrets based on build context. You can specify conditions such as the branch, pipeline, or user who triggered the build.

During a build, the policy is evaluated against the build's context. If no rule matches, access to the organization secret is denied.

## Policy schema

Policies are defined as a list of policy rules in YAML. Each _policy rule_ (beginning with a `-`) specifies one or more _conditions_ that must be met for a build to access the Buildkite organization secret. Each policy rule must specify one or more claims. Claims can be a single item or lists of strings.

### First-party claims

First-party claims are ones whose values are generated by Buildkite. This makes these claims more secure than [third-party claims](#policy-schema-third-party-claims).

<table>
  <tbody>
    <tr>
      <th><code>cluster_id</code></th>
      <td>The unique identifier of the cluster the agent belongs to.<br>
        <span class="Docs__api-param-eg"><em>Example:</em> <code>cluster_id: "550e8400-e29b-41d4-a716-446655440000"</code></span>
      </td>
    </tr>
    <tr>
      <th><code>pipeline_id</code></th>
      <td>The unique identifier of the build pipeline.<br>
        <span class="Docs__api-param-eg"><em>Example:</em> <code>pipeline_id: ""f47ac10b-58cc-4372-a567-0e02b2c3d479""</code></span>
      </td>
    </tr>
    <tr>
      <th><code>build_source</code></th>
      <td>The source of the build trigger (e.g., webhook, API).<br>
        <span class="Docs__api-param-eg"><em>Example:</em> <code>build_source: "webhook"</code></span>
      </td>
    </tr>
  </tbody>
</table>

### Third-party claims

Third-party claims are ones whose values are provided by users or third-party tools. While these claims can be useful for controlling access, they are not as secure as [first-party claims](#policy-schema-first-party-claims), which are generated by the Buildkite platform.

<table>
  <tbody>
    <tr>
      <th><code>pipeline_slug</code></th>
      <td>The slug of the build pipeline.<br>
        <span class="Docs__api-param-eg"><em>Example:</em> <code>pipeline_slug: "my-pipeline"</code></span>
      </td>
    </tr>
    <tr>
      <th><code>build_branch</code></th>
      <td>The branch being built.<br>
        <span class="Docs__api-param-eg"><em>Example:</em> <code>build_branch: "main"</code></span>
      </td>
    </tr>
    <tr>
      <th><code>build_creator</code></th>
      <td>The email of the user who triggered the build.<br>
        <span class="Docs__api-param-eg"><em>Example:</em> <code>build_creator: "user@example.com"</code></span>
      </td>
    </tr>
    <tr>
      <th><code>build_creator_team</code></th>
      <td>The UUIDs of the teams the build creator belongs to.<br>
        <span class="Docs__api-param-eg"><em>Example:</em> <code>build_creator_team: "123e4567-e89b-12d3-a456-426614174000"</code></span>
      </td>
    </tr>
  </tbody>
</table>

### Example access policy

The following example access policy contains three rules with different levels of access control. The secret is accessible only to builds that match all specified conditions for one or more of the rules.

```yaml
- cluster_id: "550e8400-e29b-41d4-a716-446655440000"
  pipeline_slug: "my-pipeline"
  build_branch: "main"
  build_creator: "user@example.com"
  build_source: "webhook"
  build_creator_team: "123e4567-e89b-12d3-a456-426614174000"

- cluster_id:
    - "550e8400-e29b-41d4-a716-446655440001"
    - "550e8400-e29b-41d4-a716-446655440002"
  pipeline_slug:
    - "frontend-pipeline"
    - "backend-pipeline"
  build_branch:
    - "main"
    - "develop"

- pipeline_slug: "public-pipeline"
  build_branch:
    - "main"
    - "release"
  build_creator:
    - "admin@example.com"
    - "deployer@example.com"
```

### Use case examples

Access policies can be tailored to fit a wide range of security and workflow requirements. Here are some practical examples of rules to help you get started.

#### Restrict secret access to the main branch of a pipeline

```yaml
- pipeline_slug: "my-pipeline"
  build_branch: "main"
```

#### Restrict secret access to only Github merge queue builds

```yaml
- pipeline_slug: "my-pipeline"
  build_branch: "gh-readonly-queue/*"
```

#### Only allow a chosen team to deploy from the main branch

```yaml
- cluster_id: "b8a1c2d3-4e5f-6789-abcd-ef0123456789"
  build_branch: "main"
  build_creator_team: "e2b7c3f4-1a5d-4e6b-9c8d-2f3a4b5c6d7e"
```

## Access policy evaluation

During a build, the access policy is evaluated against the build's context. If any rule matches, the agent is granted access to the secret. If no rules match, access is denied.

## Add an access policy

1. Select **Agents** in the global navigation to access the **Clusters** page.
1. Select the cluster in which to create the new Buildkite cluster secret.
1. Select the secret you want to secure with an access policy.
1. Select the secret's **Access** tab.
1. In the **Agent access** section, select **Restrict access to agents matching a policy**.
1. Add your policy to the **Policy** field in YAML format.
1. Select **Update agent access** to save your changes.

